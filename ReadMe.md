# Malware classification

This paper utilizes deep learning to classify the families of malware for Portable Executable 32 (PE32). More on paper.docx

# Sample Collection and Contribution:
Most samples are collected from various github repositories where the malware has been classified already. Thanks to VirusSign and VirusShare for providing access to huge range of malware collection. Most of the malware which is classified already and not classified is double checked by me to make sure the data is good enough to train a neural network. Current we have some samples(worm, downloader, keylogger and crypto-miner) lagging. These variants are hard to find. For example I have found about more than 300 samples of worm after analysing them, I found out they are all one single sample (Allaple) a polymorphic worm which makes copy of itself and every sample's copy is different in content as well as hash, But it is all one single worm (Allaple). This creates data duplication which affects the model badly as it relies heavily on those features. So finding unqiue worms have become highly difficult from repositories like VirusSign etc., If you ever have some of the collections kindly contribute by creating a pull request with the imports txt file alone (No EXE).

# Abstract
A malware is a computer program which harms the computer in which it gets executed. Malware analysis play a major role in analysing the functionalities and behaviour of the malware. Malware analysis is a slow and tedious process which involves a lot of manual work. Finding the type of the malware will often boost up the analysis process and helps to the researcher to know what the binary is capable of. Usually researchers perform various static analysis techniques to find the category of the malware using various tools like strings, dependency walker etc., But each day there are millions [1] of new malwares gets released classifying them manually is a non-feasible solution. So, in our approach we are going to automate this process using deep neural networks.

# I. INTRODUCTION
Malware analysis helps the researchers to find out the functionality of the malware. Malware analysis comprises of two major types,
1.	Static Malware analysis.
2.	Dynamic Malware analysis.

## Static Malware Analysis
In static malware analysis the malicious binaries are examined without executing and may be further subjected for reverse engineering using disassembler. Where as in dynamic malware analysis the malicious binary is actually executed in an isolated environment like sandbox to detect its behaviour.

## Keywords:
Windows Malware, Malware Analysis, Static Malware Analysis, Malware Classification.

## A. Types of malware:

## 1. Backdoor:
Backdoor is a malicious program which allows the remote attacker to gain access to the victim’s computer.
## 2. Downloader:
The sole purpose of the downloader is to download another malicious program and sometimes execute it.
## 3. Keylogger:
A keylogger is a program which continuously monitors the keystroke of the user. This helps the attacker to steal potential information like email address, password., etc.,
## 4. Miners:
This malicious program will use the resources of the victim’s computer to mine crypto-currency which is used to monetize the attacker’s wallet.
## 5. Rouge software:
Rouge software seems to behave like an original software say, antivirus and will trick the user to buy services which will end up paying to an attacker.
## 6. Trojan:
A trojan is a software which seems to behave like a legitimate program but does malicious activities in the background.
## 7. Ransomware:
A malicious program which encrypts the user’s files (pictures, documents, etc.,) and would demand a ransom for decryption. The ransom is generally collected through cryptocurrency like Bitcoins, Dash, etc.,

# B. Dataset Preparation:

## 1. Sample collection:
In order to prepare our dataset, we need actual malware samples. Various malware samples have been collected from open source GitHub repositories and mostly from Virus Share [2].  These repositories do already have most of the malware categorized which will be used for supervised learning. 
All the collected samples are stored in a separate directory depending on the category of the malware which helps in labelling of the malware. The collected sample’s category and their label is shown in Table 1.

#### Table 1: Malware Category with respective Label.
	+----------------+-------+
	|  Sample type   | Label |
	+----------------+-------+
	| Backdoor       |     0 |
	| Downloader     |     1 |
	| Keylogger      |     2 |
	| Miner          |     3 |
	| Ransomware     |     4 |
	| Rouge Software |     5 |
	| Trojan         |     6 |
	| Worm           |     7 |
	+----------------+-------+

## 2. Extracting Import functions:
In order to prepare our dataset, we need to extract all the Import functions used by the malware. A small C++ program is written which will extract all the imports from all the PE32 files present in the directory. MD5 hashing is used to prevent data duplication. Initially the program will create three separate files one to store the hashes of the scanned malware which is used to prevent data duplication, a separate file to store the imports used by all the executable of the same category and third file is used to notify when the PE32 has used a Packer[9] – UPX [8] which is a most widely used packer according to [14] rather than the custom packer. 
Packed program will not be used for dataset preparation however it will be used stored in a separate text file for identification. The program also creates individual files for each PE32 executables containing it’s import with the name of its hash. 
A packer is a program which encrypts the actual programs source, when the program is packed the size of the strings will be less, does have less import functions and the size of the executable is reduced too. When a packed executable is executed, the packer program runs first and will decrypt the executable to execute. Packers are also used for legitimate purposes for saving bandwidth by reducing size of the executable.
The famous and most commonly used packer is UPX which is an open source tool licensed under GPL, Capable of compressing portable executable.
Packed malware could evade the signature-based detection. For example: hash-based detection. Hash of the packed executable varies to hash of the original executable.
<br/>
Below is the algorithm for extracting the imports,

## Algorithm 1: Import Extraction:
	for malware in directories
		if malware == scanned:
			skip
		else if malware == packed:
			append packed.txt -> malware_hash
			skip
		imports = get_all_imports(malware)
		write malware_hash.txt -> imports
		append frequency.txt -> imports
		append scanned_file.txt -> malware_hash

Here is a visualization of Imports used by various malware [Frequency Distribution Graph]:

### Backdoor:
Backdoors which gives access to the victim’s machine to the remote attacker from the graph we could see backdoor has complete access over processes, threads and file system in an infected system.
<br/>
Noteworthy function imports in a backdoor:

	+----------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
	| Function Name  |                                                                                                Description                                                                                                |
	+----------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
	| CreateFile     | Creates a new file.                                                                                                                                                                                       |
	| GetProcAddress | Used to import other functions in addition to the imported functions from PE header. [15]                                                                                                                 |
	| GetTickCount   | This function takes no arguments and will return the no of milliseconds after the system has booted up. Very useful anti debugging technique to detect whether a malware is running in a virtual machine. |
	| VirtualAlloc   | Could be used for process injection. [15]                                                                                                                                                                 |
	+----------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+


![](static/backdoor.png)
*Figure 1. Frequency Distribution graph for backdoor.*

### Downloaders:
The sole purpose of the downloader is to download other malicious software as you can see it uses functions to create a new file for malware. Sleep functions makes a malware dormant for a certain specified period of time which generally slows down the dynamic malware analysis as its characters could not be analysed while it is inactive. <br/>
Noteworthy function in downloaders:

	+---------------+--------------+----------------------------------------------------------+
	| Function Name                |    Description                                           |
	+---------------+--------------+----------------------------------------------------------+
	| •             | CreateFile   |                                                          |
	| •             | WriteFile    | Used to save the downloaded payload in victim’s machine. |
	| •             | Sleep        |                                                          |
	| •             | GetTickCount | Anti-debugging techniques.                               |
	+---------------+--------------+----------------------------------------------------------+

![](static/downloader.png)
*Figure 1. Frequency Distribution graph for downloader.*

